{ conf, lib }:
with conf.theme;      
let
  elemAt = lib.elemAt;

  colorNames = builtins.attrNames nvimColors;
  makeHi = group:
    "hi ${group} " +
      "guifg=${(nvimColors.${group}.fg or "NONE")} " +
      "guibg=${(nvimColors.${group}.bg or "NONE")} " +
      "ctermfg=${(nvimColors.${group}.ctermfg or "NONE")} " +
      "ctermbg=${(nvimColors.${group}.ctermbg or "NONE")} " +
      "gui=${(nvimColors.${group}.gui or "NONE")} " +
      "cterm=${(nvimColors.${group}.gui or "NONE")}";
  highlights = builtins.map makeHi colorNames;
  generatedColorscheme = builtins.concatStringsSep "\n" highlights;
in
{
  target = ".config/nvim/colors/nix.vim";
  text = ''
    " File generated by L3af's Nix config
    " modify in config/theme.nix

    if version > 580
      hi clear
      if exists("syntax_on")
        syntax reset
      endif
    endif

    let g:colors_name = "nix"

    if has('nvim')
      let g:terminal_color_0 = "${elemAt nvimColors.termColors 0}"
      let g:terminal_color_1 = "${elemAt nvimColors.termColors 1}"
      let g:terminal_color_2 = "${elemAt nvimColors.termColors 2}"
      let g:terminal_color_3 = "${elemAt nvimColors.termColors 3}"
      let g:terminal_color_4 = "${elemAt nvimColors.termColors 4}"
      let g:terminal_color_5 = "${elemAt nvimColors.termColors 5}"
      let g:terminal_color_6 = "${elemAt nvimColors.termColors 6}"
      let g:terminal_color_7 = "${elemAt nvimColors.termColors 7}"
      let g:terminal_color_8 = "${elemAt nvimColors.termColors 8}"
      let g:terminal_color_9 = "${elemAt nvimColors.termColors 9}"
      let g:terminal_color_10 = "${elemAt nvimColors.termColors 10}"
      let g:terminal_color_11 = "${elemAt nvimColors.termColors 11}"
      let g:terminal_color_12 = "${elemAt nvimColors.termColors 12}"
      let g:terminal_color_13 = "${elemAt nvimColors.termColors 13}"
      let g:terminal_color_14 = "${elemAt nvimColors.termColors 14}"
      let g:terminal_color_15 = "${elemAt nvimColors.termColors 15}"
    endif

    if has('terminal')
      let g:terminal_ansi_colors = [ "${builtins.concatStringsSep "\", \"" nvimColors.termColors}" ]
    endif

    ${generatedColorscheme}
  '';
}
